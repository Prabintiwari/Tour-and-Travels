// prisma/schema.prisma
datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==================== ENUMS ====================
enum UserRole {
  ADMIN
  USER
  GUEST
}
enum DifficultyLevel {
  EASY
  MODERATE
  HARD
}

enum GuidePricingType{
  PER_DAY
  PER_GROUP
  PER_PERSON
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}
enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}
enum AccommodationType {
  HOTEL
  HOSTEL
  GUESTHOUSE
  RESORT
  APARTMENT
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH
  WALLET
  CREDIT_CARD
  DEBIT_CARD
  NET_BANKING
  UPI
}

enum CustomItineraryEventType {
  ACTIVITY
  MEAL
  TRANSPORT
  ACCOMMODATION
}


enum RentalStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum VehicleType {
  CAR
  MOTORCYCLE
  BICYCLE
  BUS
  VAN
  TRUCK
}

enum FuelType {
  PETROL
  DIESEL
  HYBRID
  ELECTRIC
}

enum VehicleStatus {
  AVAILABLE
  BOOKED
  MAINTENANCE
  INACTIVE
}


// ==================== AUTH & USER MANAGEMENT ====================

model User {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  email                 String   @unique
  password              String
  fullName              String
  phone                 String?
  profileImage          String?
  address               String?
  street                String?
  city                  String?
  country               String?
  dateOfBirth           DateTime?
  role                  UserRole @default(USER)
  isActive              Boolean  @default(true)
  isBlocked             Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  tourBookings          TourBooking[]
  vehicleBookings       VehicleBooking[]
  tourReviews           TourReview[]
  vehicleReviews        VehicleReview[]
  customItineraries     CustomItinerary[]
  tourPayments          TourPayment[]
  vehiclePayments       VehiclePayment[]

}
// TempUser Model
model TempUser {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  fullName      String
  email         String  @unique
  password      String
  phone         String?
  otp           Int
  expiry        DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ==================== DESTINATIONS ====================
model Destination {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  name                  String
  description           String?
  region                String?
  location              String
  imageUrl              String?
  imagePublicId         String?
  attractions           Json[] // Array of attraction names/descriptions/images
  bestTimeToVisit       String?
  views                 Int      @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  tours                 Tour[]
  destinationGalleries  DestinationGallery[]
  tourBookings          TourBooking[]
  tourReviews           TourReview[]
  customItineraries     CustomItinerary[]

  @@index([name])
  @@index([region])
}

// ==================== DESTINATION GALLERY ====================
model DestinationGallery {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  destinationId         String   @db.ObjectId @unique
  destination           Destination @relation(fields: [destinationId], references: [id], onDelete: Cascade)
  imageUrl              String[]
  imagePublicId         String[]  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ====================  TOUR MODEL ====================
model Tour {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  destinationId         String   @db.ObjectId
  destination           Destination @relation(fields: [destinationId], references: [id], onDelete: Cascade)

  title                 String
  description           String?
  numberOfDays          Int
  basePrice             Float
  discountRate          Float?   // e.g. 10 = 10%
  discountAmount        Float?   // fixed discount (optional)
  discountActive        Boolean  @default(false)
  finalTourPrice        Float
  
  maxParticipants       Int?
  minParticipants       Int?
  difficultyLevel       DifficultyLevel @default(EASY)
  isFeatured            Boolean  @default(false)
  isActive              Boolean  @default(true)
  
  coverImage            String?
  coverImagePublicId    String?
  images                String[] @default([]) 
  imagePublicIds        String[] @default([])

  views                 Int      @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  itineraries           Itinerary[]
  schedules             TourSchedule[]
  reviews               TourReview[]
  faqs                  TourFAQ[]
  tourBookings          TourBooking[]
  guidePricing          TourGuidePricing? 

  @@index([isFeatured])
}

// ==================== TOUR ITINERARY (Day-by-day breakdown) ====================
model Itinerary {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  tourId                String   @db.ObjectId
  tour                  Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)
  day                   Int
  title                 String
  description           String?
  
  activities            Json[] // [{ time, activity, location }]
  accommodationType     AccommodationType?
  mealInclusions        MealType[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([tourId, day])
  @@index([tourId])
}

// ==================== TOUR SCHEDULE ====================
model TourSchedule {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  tourId          String   @db.ObjectId
  tour            Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  title           String?        // e.g. "Dashain Special Batch"
  description     String?        // Why price is different
  price           Float?         // Override price for this schedule
  
  startDate       DateTime
  endDate         DateTime
  availableSeats  Int
  currentBookings Int      @default(0)
  
  isActive        Boolean  @default(true) // Optional: schedule active or cancelled

  bookings        TourBooking[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tourId])
  @@index([startDate])
}

// ==================== TOUR GUIDE PRICING ====================
model TourGuidePricing {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  
  tourId                String?  @unique @db.ObjectId 
  tour                  Tour?    @relation(fields: [tourId], references: [id], onDelete: Cascade)
  
  // If tourId is null, this is the default pricing
  isDefault             Boolean   @default(false)
  
  // Pricing options - flexible to support different models
  pricePerDay           Float?   // Fixed price per day 
  pricePerPerson        Float?   // Price per person 
  pricePerGroup         Float?   // Flat rate per group 
  
  // For complex pricing
  minimumCharge         Float?   // Minimum charge regardless of group size
  maximumGroupSize      Int?     // Max people one guide can handle
  
  // Additional metadata
  description           String?  // Describe what's included with guide service
  
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([isDefault])
  @@index([isActive])
}

// ====================  TOUR BOOKINGS ====================
model TourBooking {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  bookingCode           String   @unique

  userId                String   @db.ObjectId
  user                  User @relation(fields: [userId], references: [id], onDelete: Cascade)

  tourId                String   @db.ObjectId
  tour                  Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  scheduleId            String   @db.ObjectId
  schedule              TourSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  destinationId         String   @db.ObjectId
  destination           Destination @relation(fields: [destinationId], references: [id], onDelete: Cascade)

  numberOfParticipants  Int
  pricePerParticipantAtBooking Float // snapshot of tour price at booking

  // SNAPSHOTS (system-calculated)
  basePriceAtBooking      Float
  discountRateAtBooking   Float?   // snapshot
  discountAmountAtBooking Float?   // snapshot
  finalTourPrice          Float

  // Guide-related fields
  needsGuide           Boolean  @default(false)
  numberOfGuides       Int?     @default(0) // Number of guides needed for large groups
  guidePricingType     GuidePricingType?     // Enum: PER_DAY / PER_PERSON / PER_GROUP
  guidePriceAtBooking  Float?                 // Snapshot of price depending on type
  guideMinimumCharge   Float?                 // Snapshot (if applicable)
  guideTotalPrice      Float?                 // Calculated total guide cost

  totalPrice           Float    // Total = (tour price - discount) + guide price

  status               BookingStatus @default(PENDING)
  bookingDate          DateTime @default(now())
  cancelledAt          DateTime?
  completedAt          DateTime?
  updatedAt            DateTime @updatedAt

  payment              TourPayment?

  @@index([userId])
  @@index([tourId])
  @@index([scheduleId])
  @@index([destinationId])
  @@index([status])
  @@index([needsGuide])
}

// ==================== TOUR PAYMENTS ====================
model TourPayment {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  bookingId       String   @unique @db.ObjectId
  booking         TourBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  userId          String   @db.ObjectId
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount          Float
  status          PaymentStatus @default(PENDING)
  paymentMethod   PaymentMethod @default(CASH)
  transactionId   String?
  paymentDate     DateTime?
  paymentGatewayResponse Json?  // Optional: store raw payment gateway response

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

// ==================== TOUR REVIEWS ====================
model TourReview {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  userId                String   @db.ObjectId
  user                  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  tourId                String   @db.ObjectId
  tour                  Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)
  destinationId         String   @db.ObjectId
  destination           Destination @relation(fields: [destinationId], references: [id], onDelete: Cascade)
  rating                Float // 1-5
  comment               String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([tourId, userId])
  @@index([tourId])
  @@index([userId])
  @@index([destinationId])
}

// ==================== TOUR FAQ ====================
model TourFAQ {
  id                   String   @id @default(auto()) @map("_id") @db.ObjectId
  tourId               String   @db.ObjectId
  tour                 Tour     @relation(fields: [tourId], references: [id], onDelete: Cascade)

  question             String
  questionLower        String

  answer               String
  isActive             Boolean  @default(true)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([tourId, questionLower])
}


// ==================== CUSTOM ITINERARY ====================
model CustomItinerary {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  userId                String   @db.ObjectId
  user                  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  destinationId         String   @db.ObjectId
  destination           Destination @relation(fields: [destinationId], references: [id], onDelete: Cascade)
  title                 String
  description           String?
  numberOfDays          Int?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  events                CustomItineraryEvent[]

  @@index([userId])
  @@index([destinationId])
}

model CustomItineraryEvent {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  itineraryId   String   @db.ObjectId
  itinerary     CustomItinerary @relation(fields: [itineraryId], references: [id], onDelete: Cascade)

  day           Int?     
  order         Int?    

  title         String
  description   String?
  startTime     DateTime?
  endTime       DateTime?
  location      String?
  type          CustomItineraryEventType
  notes         String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([itineraryId])
  @@index([itineraryId, day])
}


// ==================== VEHICLE MANAGEMENT ====================
model Vehicle {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  vehicleType       VehicleType
  brand             String
  model             String?
  year              Int?

  seatCapacity      Int?
  luggageCapacity   Int?

  pricePerDay       Float
  pricePerHour      Float?
  withDriver        Boolean @default(false)

  totalQuantity     Int
  availableQuantity Int

  fuelType          FuelType  @default(PETROL)
  status            VehicleStatus @default(AVAILABLE)

  city              String
  region            String?

  images            String[]
  imagePublicIds    String[]

  features          String[]
  description       String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  bookings          VehicleBooking[]
  reviews           VehicleReview[]
  faqs              VehicleFAQ[]

  @@index([vehicleType])
  @@index([status])
  @@index([city])
}


// ==================== VEHICLE BOOKINGS ====================
model VehicleBooking {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  bookingCode           String   @unique

  userId                String   @db.ObjectId
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  vehicleId             String   @db.ObjectId
  vehicle               Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  startDate             DateTime
  endDate               DateTime
  durationDays          Int

  numberOfVehicles      Int

  pricePerDayAtBooking  Float     
  needsDriver           Boolean   @default(false)
  driverPricePerDay     Float?
  driverTotalPrice      Float?

  totalPrice            Float

  discountRate          Float?    @default(0)
  discountAmount        Float?    @default(0)

  status                RentalStatus @default(PENDING)

  bookingDate           DateTime  @default(now())
  cancelledAt           DateTime?
  completedAt           DateTime?
  updatedAt             DateTime  @updatedAt

  payment               VehiclePayment?

  @@index([userId])
  @@index([vehicleId])
  @@index([status])
}

// ==================== VEHICLE PAYMENTS ====================
model VehiclePayment {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  bookingId         String   @unique  @db.ObjectId
  booking           VehicleBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  userId            String   @db.ObjectId
  user              User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  amount            Float
  status            PaymentStatus @default(PENDING)
  paymentMethod     PaymentMethod @default(CASH)
  transactionId     String?
  paymentDate       DateTime?
  paymentGatewayResponse Json? // raw response
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

// ==================== VEHICLE REVIEWS ====================
model VehicleReview {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  vehicleId             String   @db.ObjectId
  vehicle               Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  userId                String   @db.ObjectId
  user                  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating                Int // 1-5
  comment               String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([vehicleId, userId])
  @@index([vehicleId])
  @@index([userId])
}

// ==================== VEHICLE FAQ ====================
model VehicleFAQ {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  vehicleId             String   @db.ObjectId
  vehicle               Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleType           VehicleType?
  question              String
  answer                String
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([vehicleId])
  @@index([isActive])
}